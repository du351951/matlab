function p05_reco_synchroload(nums, doreco)
% Script to loop over parameter sets related to paramters of scritp
% 'p05_reco'. Set parameters to loop over as elements of the structure
% array 'para' below. Fieldnames of 'para' MUST match the names of
% parameters in 'p05_reco'.
%
% Visual output ('visualOutput') and user interaction
% ('interactive_determination_of_rot_axis') are turned off by default if
% not set otherwise.
%
% Start loop by pushing 'F5', clicking on 'Run' in the Editor tab, or
% typing 'p05_reco_loop' in the Command Window.
%
% Written by Julian Moosmann. First version: 2017-02-15. Last: 2017-04-24

if nargin < 0
    nums = [];
end
if nargin < 2
    doreco = 1;
end
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% Parameter sets to loop over %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% Default %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
nn = 0;
default.visualOutput = 0;
default.scan_path = '';
default.raw_bin = 1;
default.excentric_rot_axis = 0;
default.crop_at_rot_axis = 0;
default.stitch_projections = 0; 
default.proj_range = 1; 
default.ref_range = 1; 
default.correlation_method =  'ssim-ml';
default.do_phase_retrieval = 0;
default.phase_retrieval_method = 'tie';'qp';'qpcut';
default.phase_retrieval_reg_par = 2.5; 
default.phase_retrieval_bin_filt = 0.15; 
default.phase_retrieval_cutoff_frequ = 1 * pi; 
default.phase_padding = 1; 
default.do_tomo = 1;
default.ring_filter = 1;
default.rot_axis_offset = [];
default.rot_axis_tilt = [];
default.parfolder = '';
default.write_to_scratch = 0;
default.write_flatcor = 1;
default.write_phase_map = 0; 
default.write_sino = 0; 
default.write_sino_phase = 0; 
default.write_reco = 1; 
default.write_float = 1; 
default.write_float_binned = 1; 
default.write_8bit = 1;
default.write_8bit_binned = 1;
default.write_16bit = 0; 

%% Data sets %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% 2017 May
raw = '/asap3/petra3/gpfs/p05/2017/data/11003950/raw/';

nn = nn + 1;para(nn) = default;para(nn).scan_path = [raw 'syn01_48L_PEEK_12w_b'];
nn = nn + 1;para(nn) = default;para(nn).scan_path = [raw 'syn01_48L_PEEK_12w_c'];
nn = nn + 1;para(nn) = default;para(nn).scan_path = [raw 'syn02_46R_PEEK_12w_a'];
nn = nn + 1;para(nn) = default;para(nn).scan_path = [raw 'syn02_46R_PEEK_12w_b'];
nn = nn + 1;para(nn) = default;para(nn).scan_path = [raw 'syn03_12R_PEEK_12w_a'];
nn = nn + 1;para(nn) = default;para(nn).scan_path = [raw 'syn03_12R_PEEK_12w_b'];
nn = nn + 1;para(nn) = default;para(nn).scan_path = [raw 'syn04_30R_PEEK_8w_a'];
nn = nn + 1;para(nn) = default;para(nn).scan_path = [raw 'syn04_30R_PEEK_8w_b'];
nn = nn + 1;para(nn) = default;para(nn).scan_path = [raw 'syn05_41R_PEEK_12w_a'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn11_53R_Mg5Gd_12w_load_broken'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_00'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_02'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_04'];para(nn).ref_range = [1:135, 137:162];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_06'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_08'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_10'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_12'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_14'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_16'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_18'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_20'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_22'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_24_noload'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn14_48L_PEEK_12w_a'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn14_48L_PEEK_12w_b'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn15_29R_PEEK_8w_a'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn15_29R_PEEK_8w_b'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn16_43R_PEEK_12w_a'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn16_43R_PEEK_12w_b'];
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn17_25R_PEEK_8w_a'];

% Radio
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_01'];para(nn).do_tomo = 0;
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_03'];para(nn).do_tomo = 0;
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_05'];para(nn).do_tomo = 0;
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_07'];para(nn).do_tomo = 0;
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_07'];para(nn).do_tomo = 0;
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_07'];para(nn).do_tomo = 0;
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_07'];para(nn).do_tomo = 0;
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_07'];para(nn).do_tomo = 0;
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_07'];para(nn).do_tomo = 0;
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_07'];para(nn).do_tomo = 0;
nn = nn + 1;para(nn) = default; para(nn).scan_path = [raw 'syn13_55L_Mg10Gd_12w_load_07'];para(nn).do_tomo = 0;


%% 2016 November

raw = '/asap3/petra3/gpfs/p05/2016/data/11001978/raw/';
% corroded screw
nn = nn + 1;para(nn) = default;para(nn).scan_path = [raw 'mah_01'];
para(nn).rot_axis_offset = -135.75 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.003;

% corroded screw
nn = nn + 1;para(nn) = default;para(nn).scan_path = [raw 'mah_02'];
para(nn).rot_axis_offset = -135.75 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.003;

% corroded screw
nn = nn + 1;para(nn) = default;para(nn).scan_path = [raw 'mah_03'];
para(nn).rot_axis_offset = -135.75 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.003;

% implant fresh
nn = nn + 1;para(nn) = default;para(nn).scan_path = [raw 'mah_04'];
para(nn).excentric_rot_axis = 1;
para(nn).crop_at_rot_axis = 1;
para(nn).rot_axis_offset = 628 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.003;
%para(nn).vol_shape = [2155 2155 1050];

% corroded screw
nn = nn + 1;
para(nn) = default;
para(nn).scan_path = [raw 'mah_05'];
para(nn).rot_axis_offset = 2 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.003;

% corroded screw
nn = nn + 1;
para(nn) = default;
para(nn).scan_path = [raw 'mah_06_Mg10G_004'];
para(nn).rot_axis_offset = 5 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.003;

% implant fresh formalin
nn = nn + 1;
para(nn) = default;
para(nn).scan_path = [raw 'mah_07_bone_in_formalin'];
para(nn).rot_axis_offset = 2 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.003;

% corrosion cell
nn = nn + 1;
para(nn) = default;
para(nn).scan_path = [raw 'mah_08_corrosion_cell_A'];
para(nn).rot_axis_offset = -3.5 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.003;

% corrosion cell
nn = nn + 1;
para(nn) = default;
para(nn).scan_path = [raw 'mah_08_corrosion_cell_B'];
para(nn).rot_axis_offset = -2 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.003;

nn = nn + 1;
para(nn) = default;
para(nn).scan_path = [raw 'mah_10_13R_top'];
para(nn).excentric_rot_axis = 1;
para(nn).rot_axis_offset = 1078 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.00267; % about -.15 degrees

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw '/mah_10_13R_bottom'];
para(nn).rot_axis_offset = 539;
para(nn).rot_axis_tilt = -0.0023;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_11_20R_top'];
para(nn).rot_axis_offset = 538.5;
para(nn).rot_axis_tilt = -0.0024;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_11_20R_bottom'];
para(nn).rot_axis_offset = 538.5;
para(nn).rot_axis_tilt = -0.0024;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_15_57R'];
para(nn).excentric_rot_axis = 0;
para(nn).crop_at_rot_axis = 0;
para(nn).rot_axis_offset = -2.5 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.0028;
para(nn).do_phase_retrieval = 0;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_15_57R'];
para(nn).excentric_rot_axis = 0;
para(nn).crop_at_rot_axis = 0;
para(nn).rot_axis_offset = -2.5 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.0028;
para(nn).do_phase_retrieval = 1;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_16_57R_load'];
para(nn).excentric_rot_axis = 0;
para(nn).crop_at_rot_axis = 0;
para(nn).rot_axis_offset = -2.5;
para(nn).rot_axis_tilt = -0.0028;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_17_57R_load_middle'];
para(nn).rot_axis_offset = 88.25;
para(nn).rot_axis_tilt = -0.0025;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_18_57R_load_top'];
para(nn).rot_axis_offset = 88.25;
para(nn).rot_axis_tilt = -0.003;

% 3.4.17
nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_20_4L_bottom'];
para(nn).rot_axis_offset = 12.5;
para(nn).rot_axis_tilt = -0.0029;
para(nn).do_phase_retrieval = 0;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).do_phase_retrieval = 1;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_22_50L_top'];
para(nn).rot_axis_offset = 88.5;
para(nn).rot_axis_tilt = -0.0028;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_23_50L_top'];
para(nn).rot_axis_offset = 5;
para(nn).rot_axis_tilt = -0.004160;
para(nn).do_phase_retrieval = 0;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_24_50L_top_load'];
para(nn).rot_axis_offset = 4.5;
para(nn).rot_axis_tilt = -0.004;
para(nn).do_phase_retrieval = 1;


nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_28_15R_top'];
para(nn).rot_axis_offset = 8.25;
para(nn).rot_axis_tilt = -0.003;
para(nn).do_phase_retrieval = 0;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_30_15R_top_occd125_withoutpaper'];
para(nn).rot_axis_offset = -3.5 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.003;
para(nn).do_phase_retrieval = 1;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_32_15R_top_occd800_withoutpaper'];
para(nn).rot_axis_offset = -79.0 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.002;
para(nn).do_phase_retrieval = 1;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_33_50L_occd400_bottom'];
para(nn).rot_axis_offset = -40 / para(nn).raw_bin;
para(nn).rot_axis_tilt = 0.00137;
para(nn).do_phase_retrieval = 1;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_33_50L_occd400_top'];
para(nn).rot_axis_offset = 5 / para(nn).raw_bin;
para(nn).rot_axis_tilt = 0.00135;
para(nn).do_phase_retrieval = 1;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_35_1R_bottom'];
para(nn).rot_axis_offset = 2 / para(nn).raw_bin;
para(nn).rot_axis_tilt = 0.00158;
para(nn).do_phase_retrieval = 0;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_36_1R_top'];
para(nn).rot_axis_offset = 2 / para(nn).raw_bin;
para(nn).rot_axis_tilt = 0.00158;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_37_10R_bottom'];
para(nn).rot_axis_offset = 0 / para(nn).raw_bin;
para(nn).rot_axis_tilt = 0.00158;

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_38_10R_top'];

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_39_3L_bottom'];

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_40_3L_top'];

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_41_9R_bottom'];

nn = nn + 1;
para(nn) = para(nn - 1);
para(nn).scan_path = [ raw 'mah_42_9R_top'];

% Straw: no proper reco possible due to movment

% corroded screw: movement
nn = nn + 1;
para(nn) = default;
para(nn).scan_path = [raw 'mah_straw_01'];
para(nn).rot_axis_offset = 2 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.003;

% corroded screw: movement
nn = nn + 1;
para(nn) = default;
para(nn).scan_path = [raw 'mah_straw_02'];
para(nn).rot_axis_offset = -1.5 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.003;

% corroded screw
nn = nn + 1;
para(nn) = default;
para(nn).scan_path = [raw 'mah_straw_03'];
para(nn).rot_axis_offset = -1.25 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.0027;
% time-varying bright spots: for nn=1:40,imsc(flat(0+(1:400),0+(1:200),nn)',[000 9000]),pause(1),end

% corroded screw
nn = nn + 1;
para(nn) = default;
para(nn).scan_path = [raw 'mah_straw_04'];
para(nn).rot_axis_offset = -1.75 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.003;

% corroded screw
nn = nn + 1;
para(nn) = default;
para(nn).scan_path = [raw 'mah_straw_05'];
para(nn).rot_axis_offset = -2.5 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.0025;

% corroded screw
nn = nn + 1;
para(nn) = default;
para(nn).scan_path = [raw 'mah_straw_06'];
para(nn).rot_axis_offset = -0 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.003;

% corroded screw
nn = nn + 1;
para(nn) = default;
para(nn).scan_path = [raw 'mah_straw_2_00'];
para(nn).rot_axis_offset = -0.4 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.003;

% corroded screw
nn = nn + 1;
para(nn) = default;
para(nn).scan_path = [raw 'mah_straw_2_00'];
para(nn).rot_axis_offset = -0.4 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.003;
para(nn).raw_bin = 2;
para(nn).parfolder = 'bin2';
para(nn).write_float_binned = 0;
para(nn).write_8bit_binned = 0;

% corroded screw
nn = nn + 1;
para(nn) = default;
para(nn).scan_path = [raw 'mah_straw_2_01'];
para(nn).rot_axis_offset = -0 / para(nn).raw_bin;
para(nn).rot_axis_tilt = -0.003;

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
fprintf( '\nDATA SETS:')
for nn = 1:numel( para)
    [~, name] = fileparts( para(nn).scan_path );
    fprintf('\n%3u : %s', nn, name )
end

if ~isempty(nums)
    fprintf( '\n\nTO BE RECONSTRUCTED:')
    for nn = 1:numel( nums )
        num = nums(nn);
        external_parameter = para(num);
        [~, name] = fileparts( external_parameter.scan_path );
        fprintf('\n%3u : %s', num, name )                
    end
end

% Loop over parameter sets
if doreco
    fprintf( '\n\nSTART LOOPING \n')
    for nn = 1:numel( nums )
        num = nums(nn);
        
        external_parameter = para(num);
        [~, name] = fileparts( external_parameter.scan_path );
        fprintf('\nRECONSTRUCTION OF DATA SET NUMBER : %u : %s\n', num, name )
        
        p05_reco
        
        
    end
    fprintf( '\nRECONSTRUCTION LOOP FINISHED')
end
fprintf('\n')
